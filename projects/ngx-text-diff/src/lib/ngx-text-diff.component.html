<td-loader-spinner [active]="loading"></td-loader-spinner>
@if (!loading) {
  <div class="td-wrapper" [ngClass]="outerContainerClass" [ngStyle]="outerContainerStyle">
    @if (showToolbar) {
      <div [ngClass]="toolbarClass" [ngStyle]="toolbarStyle">
        <div class="td-toolbar-show-diff">
          <label class="td-checkbox-container">
            Only Show Lines with Differences ({{ diffsCount }})
            <input type="checkbox" id="showDiffs" [ngModel]="hideMatchingLines" (ngModelChange)="hideMatchingLinesChanged($event)" />
            <span class="checkmark"></span>
          </label>
        </div>
      </div>
    }
    @if (showToolbar && showBtnToolbar) {
      <div class="td-toolbar-select-format">
        <div class="td-btn-group td-btn-group-toggle" data-toggle="buttons">
          @for (option of formatOptions; track option) {
            <button
              [ngClass]="{ active: format === option.value, disabled: !!option.disabled }"
              [name]="option.name"
              [id]="option.id"
              [disabled]="!!option.disabled"
              (click)="setDiffTableFormat(option.value)"
              >
              {{ option.label }}
            </button>
          }
        </div>
      </div>
    }
    <div class="td-table-wrapper" [ngClass]="compareRowsClass" [ngStyle]="compareRowsStyle">
      <!-- Right side-by-side -->
      @if (format === 'SideBySide') {
        <div class="td-table-container side-by-side" id="td-left-compare-container" tdContainer cdkScrollable>
          <table class="td-table">
            <tbody>
              @for (row of filteredTableRows; track trackTableRows($index, row)) {
                <tr>
                  <td
                    scope="row"
                    class="fit-column line-number-col"
                    [ngClass]="{ 'delete-row': row.leftContent?.prefix === '-', 'empty-row': !row.leftContent?.lineContent }"
                    >
                    {{ row.leftContent?.lineNumber !== -1 ? row.leftContent?.lineNumber : ' ' }}
                  </td>
                  <td
                    class="fit-column prefix-col"
                    [ngClass]="{ 'delete-row': row.leftContent?.prefix === '-', 'empty-row': !row.leftContent?.lineContent }"
                    >
                    <span>{{ row.leftContent?.prefix || ' ' }}</span>
                  </td>
                  @if (!row.hasDiffs) {
                    <td
                      class="content-col"
                      [ngClass]="{ 'delete-row': row.leftContent?.prefix === '-', 'empty-row': !row.leftContent?.lineContent }"
                      >
                      <span [innerHTML]="row.leftContent?.lineContent | formatLine"></span>
                    </td>
                  }
                  @if (row.hasDiffs) {
                    <td
                      class="content-col"
                      [ngClass]="{ 'delete-row': row.leftContent?.prefix === '-', 'empty-row': !row.leftContent?.lineContent }"
                      >
                      @for (diff of row.leftContent?.lineDiffs; track trackDiffs($index, diff)) {
                        <span
                          [innerHTML]="diff.content | formatLine"
                          [ngClass]="{ highlight: diff.isDiff }"
                        ></span>
                      }
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
      <!-- Left side-by-side -->
      @if (format === 'SideBySide') {
        <div class="td-table-container side-by-side" id="td-right-compare-container" tdContainer cdkScrollable>
          <table class="td-table">
            <tbody>
              @for (row of filteredTableRows; track trackTableRows($index, row)) {
                <tr>
                  <td
                    scope="row"
                    class="fit-column line-number-col"
                    [ngClass]="{ 'insert-row': row.rightContent?.prefix === '+', 'empty-row': !row.rightContent?.lineContent }"
                    >
                    {{ row.rightContent?.lineNumber !== -1 ? row.rightContent?.lineNumber : ' ' }}
                  </td>
                  <td
                    class="fit-column prefix-col"
                    [ngClass]="{ 'insert-row': row.rightContent?.prefix === '+', 'empty-row': !row.rightContent?.lineContent }"
                    >
                    <span>{{ row.rightContent?.prefix || ' ' }}</span>
                  </td>
                  @if (!row.hasDiffs) {
                    <td
                      class="content-col"
                      [ngClass]="{ 'insert-row': row.rightContent?.prefix === '+', 'empty-row': !row.rightContent?.lineContent }"
                      >
                      <span [innerHTML]="row.rightContent?.lineContent | formatLine"></span>
                    </td>
                  }
                  @if (row.hasDiffs) {
                    <td
                      class="content-col"
                      [ngClass]="{ 'insert-row': row.rightContent?.prefix === '+', 'empty-row': !row.rightContent?.lineContent }"
                      >
                      @for (diff of row.rightContent?.lineDiffs; track trackDiffs($index, diff)) {
                        <span
                          [innerHTML]="diff.content | formatLine"
                          [ngClass]="{ highlight: diff.isDiff }"
                        ></span>
                      }
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
      <!-- Line By Line - combined table -->
      @if (format === 'LineByLine') {
        <div class="td-table-container line-by-line">
          <table class="td-table">
            <tbody>
              @for (row of filteredTableRowsLineByLine; track trackTableRows($index, row)) {
                <tr>
                  <td scope="row" class="fit-column line-number-col-left">{{ row.leftContent?.lineNumber }}</td>
                  <td scope="row" class="fit-column line-number-col">{{ row.rightContent?.lineNumber }}</td>
                  <td
                    class="fit-column prefix-col"
                    [ngClass]="{ 'delete-row': row.leftContent?.prefix === '-', 'insert-row': row.rightContent?.prefix === '+' }"
                    >
                    <span>{{ row.leftContent?.prefix || row.rightContent?.prefix || ' ' }}</span>
                  </td>
                  @if (!row.hasDiffs) {
                    <td
                      class="content-col"
                      [ngClass]="{ 'delete-row': row.leftContent?.prefix === '-', 'insert-row': row.rightContent?.prefix === '+' }"
                      >
                      <span [innerHTML]="row.leftContent?.lineContent | formatLine"></span>
                    </td>
                  }
                  @if (row.hasDiffs && row.leftContent && row.leftContent?.lineDiffs.length !== 0) {
                    <td
                      class="content-col"
                      [ngClass]="{ 'delete-row': row.leftContent?.prefix === '-', 'insert-row': row.rightContent?.prefix === '+' }"
                      >
                      @for (diff of row.leftContent?.lineDiffs; track trackDiffs($index, diff)) {
                        <span
                          [innerHTML]="diff.content | formatLine"
                          [ngClass]="{ highlight: diff.isDiff }"
                        ></span>
                      }
                    </td>
                  }
                  @if (row.hasDiffs && row.rightContent && row.rightContent?.lineDiffs.length !== 0) {
                    <td
                      class="content-col"
                      [ngClass]="{ 'delete-row': row.leftContent?.prefix === '-', 'insert-row': row.rightContent?.prefix === '+' }"
                      >
                      @for (diff of row.rightContent?.lineDiffs; track trackDiffs($index, diff)) {
                        <span
                          [innerHTML]="diff.content | formatLine"
                          [ngClass]="{ highlight: diff.isDiff }"
                        ></span>
                      }
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>
  </div>
}
